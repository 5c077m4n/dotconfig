#!/usr/bin/env -S deno run --allow-net --allow-read --allow-write

const HOSTS_PATH = "/etc/hosts";
const NUMBER_FORMATTER = new Intl.NumberFormat();

function filterComments(lines: string): string[] {
	return lines
		.split("\n")
		.map((l) => l.trim())
		.filter((l) => !l.startsWith("#"));
}

async function getHosts(url: string | URL): Promise<string[]> {
	const hostsFileResponse = await fetch(url);
	const text = await hostsFileResponse.text();

	return filterComments(text);
}

async function main(): Promise<void> {
	const localHostsFile = await Deno.readTextFile(HOSTS_PATH);
	const localHostsLines = filterComments(localHostsFile);

	console.log("fetching anti malware hosts...");
	const antiMalwareHosts = await getHosts(
		"https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts",
	);
	console.log("fetching anti fake news hosts...");
	const fakeNewsGamblingHosts = await getHosts(
		"https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling/hosts",
	);

	const allHosts = new Set<string>([
		...localHostsLines,
		...antiMalwareHosts,
		...fakeNewsGamblingHosts,
	]);
	const allHostsText = Array.from(allHosts).join("\n");

	await Deno.copyFile(HOSTS_PATH, `${HOSTS_PATH}.${Date.now()}`);
	await Deno.writeTextFile(HOSTS_PATH, allHostsText);

	console.log(
		`All done! (added ${NUMBER_FORMATTER.format(allHosts.size)} hosts)`,
	);
}

await main();
